{% extends "admin/base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - å¢¨æ°´å±ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-chart-line me-2"></i>ä»ªè¡¨ç›˜</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshDashboard">
                <i class="fas fa-sync-alt"></i> åˆ·æ–°
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-snowflake"></i> åœ£è¯ä¸»é¢˜
            </button>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats bg-primary text-white shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-5">
                        <div class="icon-big text-center">
                            <i class="fas fa-desktop"></i>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="numbers">
                            <p class="card-category">è®¾å¤‡æ€»æ•°</p>
                            <h3 class="card-title">{{ device_count }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fas fa-clock"></i> æœ€è¿‘æ›´æ–°: {{ last_update or 'åˆšåˆš' }}
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats bg-success text-white shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-5">
                        <div class="icon-big text-center">
                            <i class="fas fa-wifi"></i>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="numbers">
                            <p class="card-category">æ´»è·ƒè®¾å¤‡</p>
                            <h3 class="card-title">{{ active_device_count }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fas fa-signal"></i> åœ¨çº¿ç‡: {{ ((active_device_count / device_count * 100) | round(1) if device_count > 0 else 0) }}%
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats bg-info text-white shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-5">
                        <div class="icon-big text-center">
                            <i class="fas fa-images"></i>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="numbers">
                            <p class="card-category">å†…å®¹æ€»æ•°</p>
                            <h3 class="card-title">{{ content_count }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fas fa-database"></i> å­˜å‚¨ç©ºé—´: {{ storage_usage or 'æœªçŸ¥' }}
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats bg-warning text-white shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-5">
                        <div class="icon-big text-center">
                            <i class="fas fa-tasks"></i>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="numbers">
                            <p class="card-category">å¾…åŠäº‹é¡¹</p>
                            <h3 class="card-title">{{ todo_count }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fas fa-check-circle"></i> å®Œæˆç‡: {{ ((completed_todo_count / todo_count * 100) | round(1) if todo_count > 0 else 0) }}%
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats bg-danger text-white shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-5">
                        <div class="icon-big text-center">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="numbers">
                            <p class="card-category">å¾…å®Œæˆ</p>
                            <h3 class="card-title">{{ pending_todo_count }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fas fa-clock"></i> å¾…å¤„ç†ä»»åŠ¡
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- æœ€è¿‘ä¸Šçº¿çš„è®¾å¤‡ -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-history me-2"></i>æœ€è¿‘ä¸Šçº¿çš„è®¾å¤‡
                </h6>
                <a href="/admin/devices" class="btn btn-sm btn-primary">
                    <i class="fas fa-list me-1"></i>æŸ¥çœ‹å…¨éƒ¨
                </a>
            </div>
            <div class="card-body">
                {% if recent_devices %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fas fa-barcode me-1"></i>è®¾å¤‡ID</th>
                                <th><i class="fas fa-tag me-1"></i>åç§°</th>
                                <th><i class="fas fa-toggle-on me-1"></i>çŠ¶æ€</th>
                                <th><i class="fas fa-clock me-1"></i>æœ€åä¸Šçº¿</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in recent_devices %}
                            <tr>
                                <td><a href="/admin/devices/{{ device.device_id }}" class="text-decoration-none"><code>{{ device.device_id }}</code></a></td>
                                <td>{{ device.name }}</td>
                                <td>
                                    {% if device.is_online %}
                                    <span class="badge bg-success"><i class="fas fa-wifi me-1"></i>åœ¨çº¿</span>
                                    {% else %}
                                    <span class="badge bg-secondary"><i class="fas fa-wifi-slash me-1"></i>ç¦»çº¿</span>
                                    {% endif %}
                                </td>
                                <td>{{ device.last_online.strftime('%Y-%m-%d %H:%M') if device.last_online else 'ä»æœª' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">æš‚æ— è®¾å¤‡</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- æœ€è¿‘å¾…åŠäº‹é¡¹ -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-tasks me-2"></i>æœ€è¿‘å¾…åŠäº‹é¡¹
                </h6>
                <a href="/admin/todos" class="btn btn-sm btn-primary">
                    <i class="fas fa-list me-1"></i>æŸ¥çœ‹å…¨éƒ¨
                </a>
            </div>
            <div class="card-body">
                {% if recent_todos %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fas fa-heading me-1"></i>æ ‡é¢˜</th>
                                <th><i class="fas fa-mobile-alt me-1"></i>è®¾å¤‡</th>
                                <th><i class="fas fa-check me-1"></i>çŠ¶æ€</th>
                                <th><i class="fas fa-calendar me-1"></i>åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in recent_todos %}
                            {% set todo = item.todo %}
                            {% set device = item.device %}
                            <tr>
                                <td><a href="/admin/todos/{{ todo.id }}" class="text-decoration-none">{{ todo.title }}</a></td>
                                <td><a href="/admin/devices/{{ device.device_id }}" class="text-decoration-none">{{ device.name or device.device_id }}</a></td>
                                <td>
                                    {% if todo.is_completed %}
                                    <span class="badge bg-success"><i class="fas fa-check me-1"></i>å·²å®Œæˆ</span>
                                    {% else %}
                                    <span class="badge bg-warning"><i class="fas fa-clock me-1"></i>å¾…å®Œæˆ</span>
                                    {% endif %}
                                </td>
                                <td>{{ todo.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <p class="text-muted">æš‚æ— å¾…åŠäº‹é¡¹</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- å¿«æ·æ“ä½œ -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-rocket me-2"></i>å¿«æ·æ“ä½œ
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="/admin/devices/add" class="btn btn-primary btn-lg btn-block">
                            <i class="fas fa-plus me-2"></i> æ·»åŠ è®¾å¤‡
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/admin/contents/add" class="btn btn-info btn-lg btn-block">
                            <i class="fas fa-plus me-2"></i> æ·»åŠ å†…å®¹
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/admin/todos/add" class="btn btn-warning btn-lg btn-block">
                            <i class="fas fa-plus me-2"></i> æ·»åŠ å¾…åŠ
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/admin/todos" class="btn btn-success btn-lg btn-block">
                            <i class="fas fa-tasks me-2"></i> å¾…åŠç®¡ç†
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç³»ç»ŸçŠ¶æ€ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-heartbeat me-2"></i>ç³»ç»ŸçŠ¶æ€
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-database fa-2x text-primary"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">æ•°æ®åº“</h6>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted">è¿æ¥æ­£å¸¸</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-network-wired fa-2x text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">MQTTæœåŠ¡</h6>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted">è¿è¡Œä¸­</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-microchip fa-2x text-warning"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">å­˜å‚¨ç©ºé—´</h6>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted">å·²ä½¿ç”¨ 45%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // åˆ·æ–°ä»ªè¡¨ç›˜
    document.getElementById('refreshDashboard').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        setTimeout(() => {
            location.reload();
        }, 500);
    });
    
    // ä¸»é¢˜åˆ‡æ¢
    document.getElementById('themeToggle').addEventListener('click', function() {
        const body = document.body;
        const isChristmas = body.classList.contains('christmas-theme');
        
        if (isChristmas) {
            body.classList.remove('christmas-theme');
            localStorage.setItem('theme', 'default');
            this.innerHTML = '<i class="fas fa-snowflake"></i> åœ£è¯ä¸»é¢˜';
            showToast('å·²åˆ‡æ¢åˆ°é»˜è®¤ä¸»é¢˜', 'info');
        } else {
            body.classList.add('christmas-theme');
            localStorage.setItem('theme', 'christmas');
            this.innerHTML = '<i class="fas fa-sun"></i> é»˜è®¤ä¸»é¢˜';
            showToast('å·²åˆ‡æ¢åˆ°åœ£è¯ä¸»é¢˜', 'success');
            
            // æ·»åŠ åœ£è¯ç‰¹æ•ˆ
            addChristmasEffects();
        }
    });
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¸»é¢˜è®¾ç½®
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'christmas') {
            document.body.classList.add('christmas-theme');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i> é»˜è®¤ä¸»é¢˜';
            addChristmasEffects();
        }
    });
    
    // æ·»åŠ åœ£è¯ç‰¹æ•ˆ
    function addChristmasEffects() {
        // åˆ›å»ºé›ªèŠ±æ•ˆæœ
        createSnowflakes();
        
        // æ·»åŠ åœ£è¯è£…é¥°
        addChristmasDecorations();
    }
    
    // åˆ›å»ºé›ªèŠ±æ•ˆæœ
    function createSnowflakes() {
        // å¦‚æœå·²ç»å­˜åœ¨é›ªèŠ±å®¹å™¨ï¼Œå…ˆç§»é™¤
        const existingSnowflakes = document.getElementById('snowflakes-container');
        if (existingSnowflakes) {
            existingSnowflakes.remove();
        }
        
        // åˆ›å»ºé›ªèŠ±å®¹å™¨
        const snowflakesContainer = document.createElement('div');
        snowflakesContainer.id = 'snowflakes-container';
        snowflakesContainer.style.position = 'fixed';
        snowflakesContainer.style.top = '0';
        snowflakesContainer.style.left = '0';
        snowflakesContainer.style.width = '100%';
        snowflakesContainer.style.height = '100%';
        snowflakesContainer.style.pointerEvents = 'none';
        snowflakesContainer.style.zIndex = '999';
        snowflakesContainer.style.overflow = 'hidden';
        
        // åˆ›å»ºé›ªèŠ±
        for (let i = 0; i < 50; i++) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.innerHTML = 'â„';
            snowflake.style.position = 'absolute';
            snowflake.style.top = Math.random() * 100 + '%';
            snowflake.style.left = Math.random() * 100 + '%';
            snowflake.style.fontSize = Math.random() * 10 + 10 + 'px';
            snowflake.style.opacity = Math.random() * 0.7 + 0.3;
            snowflake.style.animation = `fall ${Math.random() * 5 + 5}s linear infinite`;
            snowflake.style.animationDelay = Math.random() * 5 + 's';
            
            snowflakesContainer.appendChild(snowflake);
        }
        
        document.body.appendChild(snowflakesContainer);
        
        // æ·»åŠ é›ªèŠ±ä¸‹è½åŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                from { transform: translateY(-100px); }
                to { transform: translateY(calc(100vh + 100px)); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // æ·»åŠ åœ£è¯è£…é¥°
    function addChristmasDecorations() {
        // åœ¨é¡µé¢é¡¶éƒ¨æ·»åŠ åœ£è¯è£…é¥°æ¨ªå¹…
        const header = document.querySelector('nav.navbar');
        if (header && !header.classList.contains('christmas-decorated')) {
            header.classList.add('christmas-decorated');
            
            // åˆ›å»ºåœ£è¯è£…é¥°
            const decorations = document.createElement('div');
            decorations.className = 'christmas-decorations';
            decorations.style.position = 'absolute';
            decorations.style.top = '0';
            decorations.style.left = '0';
            decorations.style.width = '100%';
            decorations.style.height = '10px';
            decorations.style.background = 'linear-gradient(90deg, #ff0000, #00ff00, #ff0000, #00ff00, #ff0000)';
            decorations.style.zIndex = '10';
            
            header.style.position = 'relative';
            header.appendChild(decorations);
            
            // æ·»åŠ åœ£è¯å¸½åˆ°logo
            const logo = document.querySelector('.navbar-brand');
            if (logo && !logo.querySelector('.christmas-hat')) {
                const hat = document.createElement('span');
                hat.className = 'christmas-hat';
                hat.innerHTML = 'ğŸ…';
                hat.style.marginLeft = '5px';
                logo.appendChild(hat);
            }
        }
    }
    
    // Toasté€šçŸ¥å‡½æ•°
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger'} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '1050';
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'exclamation-circle'} me-2"></i>${message}`;
        document.body.appendChild(toast);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 500);
        }, 3000);
    }
</script>
{% endblock %}